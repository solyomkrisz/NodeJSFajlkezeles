<!DOCTYPE html>
<html lang="hu">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>4. feladat</title>
        <!--!Bootstrap-->
        <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css" />
        <!--?Popper: dropdowns, popovers, tooltips-->
        <script src="../bootstrap/js/popper.min.js"></script>
        <script src="../bootstrap/js/bootstrap.min.js"></script>
        <!--!CSS-->
        <link rel="stylesheet" href="../css/index.css" />
        <!--!JavaScript-->
        <script src="../javascript/index.js"></script>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row mb-3">
                <h1 class="display-4 shadow-sm text-start">4. feladat</h1>
            </div>

            <div class="row">
                <div class="col-12 text-center">
                    <label for="caves" class="form-label">Válasszon barlangot</label>
                    <select id="caves" class="form-control text-center w-25 mx-auto"></select>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <h2 class="h4" id="nev"></h2>
                    <ul id="info"></ul>
                </div>
            </div>

            <hr />

            <div class="row">
                <div class="col-12">
                    <button class="w-75 d-block mx-auto btn btn-outline-primary">
                        Kvíz kezdése
                    </button>
                    <div class="kviz">
                        <label
                            class="text-center w-100 form-label my-2"
                            for="valasz"
                            id="kerdes"
                        ></label>
                        <input class="form-control w-75 d-block mx-auto" id="valasz" type="text" />
                        <button
                            class="w-75 d-block mx-auto my-2 btn btn-outline-success"
                            id="ellenorzes"
                        >
                            Ellenőrzés
                        </button>
                        <div id="response" class="w-75 d-block mx-auto alert"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            async function requestData(url) {
                return await fetch(url).then(async (response) => {
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                });
            }

            async function fillSelect() {
                const select = document.querySelector('select');
                select.textContent = '';

                const { result } = await requestData('/api/barlangok');

                for (const cave of result) {
                    const option = document.createElement('option');
                    option.textContent = cave.nev;
                    option.value = cave.azon;
                    select.appendChild(option);
                }
            }

            async function selectionChange(e) {
                const { success, result } = await requestData('/api/barlang/' + e.srcElement.value);

                document.querySelector('#nev').textContent = result.nev;
                const info = document.querySelector('#info');
                info.textContent = '';

                for (const key of Object.keys(result)) {
                    if (key === 'nev') continue;

                    const li = document.createElement('li');
                    li.textContent = `${key}: ${result[key]}`;
                    info.appendChild(li);
                }
            }

            const QAs = [
                ['Mi a neve a leghosszabb barlangnak?', 'leghosszabb'],
                ['Milyen mély a legmélyebb barlang?', 'legmelyebb'],
                ['Hány barlang adata van eltárolva?', 'barlangokSzama'],
                ['Hány fokozottan védett barlang van?', 'fokozottanVedett']
            ];

            const QA = QAs[Math.floor(Math.random() * QAs.length)];

            function showRandomQuestion() {
                document.querySelector('#kerdes').textContent = QA[0];
            }

            async function checkAnswer() {
                const a = document.querySelector('#valasz').value;
                const s = (await requestData('/api/stat')).result;
                const c = document.querySelector('#response');
                if (a === s[QA[1]]) {
                    c.textContent = 'Gratulálok eltaláltad';
                    c.classList.add('alert-success');
                    c.classList.remove('alert-danger');
                } else {
                    c.textContent = 'Helyes válasz: ' + s[QA[1]];
                    c.classList.remove('alert-success');
                    c.classList.add('alert-danger');
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                document.querySelector('select').addEventListener('change', selectionChange);
                fillSelect();
                showRandomQuestion();
                document.querySelector('#ellenorzes').addEventListener('click', checkAnswer);
            });
        </script>
    </body>
</html>
